<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>API Tester</title>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
    }
    .container {
        max-width: 400px;
        margin: 0 auto;
    }
    h2 {
        color: #333;
        margin-top: 0;
    }
    label {
        font-weight: bold;
        margin-bottom: 5px;
    }
    input[type="text"], textarea {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 10px;
        width: 100%;
        box-sizing: border-box;
    }
    button {
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: block;
        margin-top: 10px;
    }
    button:hover {
        background-color: #0056b3;
    }
    .key-container {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
        margin-top: 20px;
    }
    .key-button {
        margin: 5px;
        padding: 8px 12px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: block;
    }
    .key-button:hover {
        background-color: #0056b3;
    }
    .tree-node {
        margin-left: 20px;
    }
    .toggle-indicator {
        display: inline-block;
        margin-right: 5px;
    }
    .toggle-indicator::before {
        content: '+';
        color: #007bff;
        cursor: pointer;
    }
    .toggle-indicator.expanded::before {
        content: '-';
    }
    #valueDisplay {
        margin-top: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
    }
    .loading {
        display: none;
        text-align: center;
    }
    .loading::after {
        content: 'Loading...';
        display: inline-block;
        margin-left: 5px;
    }
</style>
<script>
    function testAPI() {
    var url = document.getElementById("apiUrl").value;
    
    // Check if URL includes HTTP/HTTPS protocol
    if (!/^https?:\/\//i.test(url)) {
        document.getElementById("response").value = "Error: URL must include HTTP/HTTPS protocol.";
        return;
    }

    var xhr = new XMLHttpRequest();

    // Clear response input field
    document.getElementById("response").value = "";

    // Show loading animation
    document.getElementById("loading").style.display = "block";

    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            // Hide loading animation
            document.getElementById("loading").style.display = "none";

            var response = xhr.responseText;
            if (xhr.status == 200) {
                // If successful response
                document.getElementById("response").value = response;
                try {
                    var jsonObject = JSON.parse(response);
                    showKeys(jsonObject, [], url, document.getElementById("keySelection"));
                } catch (error) {
                    document.getElementById("keySelection").innerHTML = "";
                }
            } else {
                // If error response
                var errorMessage = "Error: ";
                if (xhr.status === 0) {
                    errorMessage += "Connection failed. Possible causes: CORS policy, network issues, or incorrect URL.";
                    // Suggesting a possible solution for CORS issues
                    errorMessage += "\nSolution: If you're facing CORS issues, try using a proxy server or contacting the API provider to enable CORS.";
                } else {
                    errorMessage += xhr.status + " " + xhr.statusText;
                }
                document.getElementById("response").value = errorMessage;
            }
        }
    };

    xhr.open("GET", url, true);
    xhr.send();
}




    function showKeys(obj, path, url, parentNode) {
        parentNode.innerHTML = "";
        for (var key in obj) {
            if (typeof obj[key] === 'object') {
                var node = document.createElement("div");
                node.className = "tree-node";
                var indicator = document.createElement("span");
                indicator.className = "toggle-indicator";
                indicator.onclick = function() {
                    toggleNode(this);
                };
                node.appendChild(indicator);
                var keyText = document.createTextNode(key);
                node.appendChild(keyText);
                parentNode.appendChild(node);
                var subNode = document.createElement("div");
                subNode.style.display = "none";
                node.appendChild(subNode);
                showKeys(obj[key], path.concat(key), url, subNode);
            } else {
                var keyPath = path.concat(key).join('.');
                var button = document.createElement("button");
                button.textContent = keyPath;
                button.className = "key-button";
                
                (function(key) {
                    button.onmouseover = function() {
                        var value = obj[key];
                        document.getElementById("valueDisplay").value = value;
                    };
                })(key);
                
                button.onmouseout = function() {
                    document.getElementById("valueDisplay").value = "";
                };
                button.onclick = function() {
                    selectKey(url, this.textContent);
                };
                parentNode.appendChild(button);
            }
        }
    }

    function toggleNode(indicator) {
        var node = indicator.parentNode.querySelector('.tree-node > div');
        if (node.style.display === 'none') {
            node.style.display = 'block';
            indicator.classList.add('expanded');
        } else {
            node.style.display = 'none';
            indicator.classList.remove('expanded');
        }
    }

    function selectKey(url, selectedKey) {
        var result = {
            "url": url,
            "key": selectedKey
        };
        document.getElementById("result").value = JSON.stringify(result);
    }

    function saveResult() {
        var resultObject = JSON.parse(document.getElementById("result").value);
        chrome.storage.local.set({"result": resultObject}, function() {
            console.log("Result saved to storage:", resultObject);
        });
    }

    function filterKeys() {
    var input, filter, keyContainer, keys, i;
    input = document.getElementById("keySearch");
    filter = input.value.toUpperCase();
    keyContainer = document.getElementById("keySelection");
    keys = keyContainer.getElementsByTagName("button");
    for (i = 0; i < keys.length; i++) {
        var button = keys[i];
        var parentDiv = button.parentNode;
        if (button.textContent.toUpperCase().indexOf(filter) > -1) {
            button.style.display = "";
            parentDiv.style.display = "";
        } else {
            button.style.display = "none";
            parentDiv.style.display = parentDiv.querySelectorAll('.key-button[style="display: none;"]').length === parentDiv.querySelectorAll('.key-button').length ? "none" : "";
        }
    }
}

</script>
</head>
<body>
    <div class="container">
        <h2>API Tester</h2>
        <label for="apiUrl">Step 1/3: Enter API URL:</label>
        <input type="text" id="apiUrl" placeholder="https://api.example.com">
        <button onclick="testAPI()">Test</button>
        <div id="loading" class="loading"></div>
        <label for="response">Raw Response:</label>
        <textarea id="response" rows="10" cols="30" disabled></textarea>
        <label for="keySelection">Step 2/3: Select the key:</label>
        <input type="text" id="keySearch" onkeyup="filterKeys()" placeholder="Search for a key..">
        <div id="keySelection" class="key-container"></div>
        <input type="text" id="valueDisplay" placeholder="Hover over a key to see its value" disabled>
        <label for="result">Result:</label>
        <textarea id="result" rows="3" cols="30" disabled></textarea>
        <button onclick="saveResult()">Save</button>
    </div>
</body>
</html>
